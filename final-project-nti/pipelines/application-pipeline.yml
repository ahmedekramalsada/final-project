trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**

pool:
  vmImage: "ubuntu-latest"

variables:
  # Make sure these are defined in a Variable Group or Secret variables
  nexus_service_connection: "nexus-connection"
  nexus_repository_name: "final-project-repo"
  nexus_url: "your-nexus-url.com" # ADD THIS VARIABLE
  image_tag: "$(Build.BuildId)"
  sonarqube_connection: "SonarQube-Connection"

steps:
  # FIX: Use @6 instead of @5 if @5 is not found
  - task: SonarQubePrepare@6
    displayName: "Prepare SonarQube Analysis"
    inputs:
      SonarQube: "$(sonarqube_connection)"
      scannerMode: "CLI"
      configMode: "manual"
      cliProjectKey: "final-project-app"
      cliProjectName: "Final Project App"
      cliSources: "final-project-nti"

  - task: SonarQubeAnalyze@6
    displayName: "Run SonarQube Analysis"

  - task: SonarQubePublish@6
    displayName: "Publish Quality Gate Result"
    inputs:
      pollingTimeoutSec: "300"

  - task: Docker@2
    displayName: "Build and Push Docker Image to Nexus"
    inputs:
      containerRegistry: "$(nexus_service_connection)"
      repository: "$(nexus_repository_name)"
      command: "buildAndPush"
      Dockerfile: "final-project-nti/app/Dockerfile"
      buildContext: "final-project-nti/app" # Explicit context is safer
      tags: |
        $(image_tag)
        latest

  - script: |
      # 1. Install Trivy
      sudo apt-get install wget apt-transport-https gnupg lsb-release -y
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update
      sudo apt-get install trivy -y

      # 2. Run Trivy Scan (Note the TRIVY_ specific env vars)
      export TRIVY_USERNAME=$(NEXUS_USERNAME)
      export TRIVY_PASSWORD=$(NEXUS_PASSWORD)

      trivy image --exit-code 0 --severity MEDIUM,HIGH,CRITICAL $(nexus_url)/$(nexus_repository_name):$(image_tag)
    displayName: "Trivy Container Image Scan"

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifacts (Manifests)"
    inputs:
      PathtoPublish: "final-project-nti/k8s"
      ArtifactName: "manifests"

  - script: |
      echo "Updating k8s deployment with new tag $(image_tag)..."
      # Using a different separator '|' in sed because the URL contains '/'
      sed -i "s|image: .*|image: $(nexus_url)/$(nexus_repository_name):$(image_tag)|g" final-project-nti/k8s/deployment.yaml
    displayName: "Update Manifests (Placeholder)"

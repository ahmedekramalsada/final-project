trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**

pool:
  vmImage: "ubuntu-latest"

variables:
  nexus_service_connection: "nexus-connection" # Ensure this Service Connection exists in Azure DevOps
  nexus_repository_name: "final-project-repo" # Match your Nexus repository name
  image_tag: "$(Build.BuildId)"
  sonarqube_connection: "SonarQube-Connection"

steps:
  - task: SonarQubePrepare@5
    displayName: "Prepare SonarQube Analysis"
    inputs:
      SonarQube: "$(sonarqube_connection)"
      scannerMode: "CLI"
      configMode: "manual"
      cliProjectKey: "final-project-app"
      cliProjectName: "Final Project App"
      cliSources: "final-project-nti"

  - task: SonarQubeAnalyze@5
    displayName: "Run SonarQube Analysis"

  - task: SonarQubePublish@5
    displayName: "Publish Quality Gate Result"
    inputs:
      pollingTimeoutSec: "300"

  - task: Docker@2
    displayName: "Build and Push Docker Image to Nexus"
    inputs:
      containerRegistry: "$(nexus_service_connection)"
      repository: "$(nexus_repository_name)"
      command: "buildAndPush"
      Dockerfile: "final-project-nti/app/Dockerfile"
      tags: |
        $(image_tag)
        latest

  - script: |
      # Install Trivy
      sudo apt-get install wget apt-transport-https gnupg lsb-release
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update
      sudo apt-get install trivy

      # Run Trivy Scan
      # Assuming the agent allows insecure registry or Nexus has valid certs.
      trivy image --exit-code 0 --severity MEDIUM,HIGH,CRITICAL $(nexus_url)/$(nexus_repository_name):$(image_tag)
    displayName: "Trivy Container Image Scan"
    env:
      NEXUS_USERNAME: $(NEXUS_USERNAME) # Ensure these env vars are available
      NEXUS_PASSWORD: $(NEXUS_PASSWORD)

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifacts (Manifests)"
    inputs:
      PathtoPublish: "final-project-nti/k8s"
      ArtifactName: "manifests"

  # Optional: Add a step to update GitOps repo if using Argocd-image-updater or separate repo
  # For now, we assume ArgoCD watches this repo or image updater handles it.
  # If you need to manually update a value in a file:
  - script: |
      echo "Updating k8s deployment with new tag $(image_tag)..."
      sed -i "s|image: .*|image: $(nexus_url)/$(nexus_repository_name):$(image_tag)|g" final-project-nti/k8s/deployment.yaml
      # In a real GitOps flow, you would git commit and push this change back to the repo.
    displayName: "Update Manifests (Placeholder)"

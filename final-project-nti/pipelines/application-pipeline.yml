trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**

pool:
  vmImage: "ubuntu-latest"

variables:
  aws_service_connection: "AWS-Connection" # Replace with your Actual Service Connection Name
  ecr_repository_name: "final-project-repo" # Match your ECR repository name from terraform
  image_tag: "$(Build.BuildId)"
  sonarqube_connection: "SonarQube-Connection" # Replace with your Actual Service Connection Name

steps:
  - task: SonarQubePrepare@5
    displayName: "Prepare SonarQube Analysis"
    inputs:
      SonarQube: "$(sonarqube_connection)"
      scannerMode: "CLI"
      configMode: "manual"
      cliProjectKey: "final-project-app"
      cliProjectName: "Final Project App"
      cliSources: "."

  - task: SonarQubeAnalyze@5
    displayName: "Run SonarQube Analysis"

  - task: SonarQubePublish@5
    displayName: "Publish Quality Gate Result"
    inputs:
      pollingTimeoutSec: "300"

  - task: Docker@2
    displayName: "Build and Push Docker Image"
    inputs:
      containerRegistry: "$(aws_service_connection)" # Ensure you have a Docker Registry Service Connection linked to ECR
      repository: "$(ecr_repository_name)"
      command: "buildAndPush"
      Dockerfile: "app/Dockerfile"
      tags: |
        $(image_tag)
        latest

  - script: |
      # Install Trivy
      sudo apt-get install wget apt-transport-https gnupg lsb-release
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update
      sudo apt-get install trivy

      # Run Trivy Scan
      trivy image --exit-code 0 --severity MEDIUM,HIGH,CRITICAL $(aws_account_id).dkr.ecr.$(aws_region).amazonaws.com/$(ecr_repository_name):$(image_tag)
    displayName: "Trivy Container Image Scan"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID) # Ensure these env vars are available from the service connection or agent
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(aws_region)

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifacts (Manifests)"
    inputs:
      PathtoPublish: "k8s"
      ArtifactName: "manifests"

  # Optional: Add a step to update GitOps repo if using Argocd-image-updater or separate repo
  # For now, we assume ArgoCD watches this repo or image updater handles it.
  # If you need to manually update a value in a file:
  - script: |
      echo "Updating k8s deployment with new tag $(image_tag)..."
      sed -i "s|image: .*|image: $(aws_account_id).dkr.ecr.$(aws_region).amazonaws.com/$(ecr_repository_name):$(image_tag)|g" k8s/deployment.yaml
      # In a real GitOps flow, you would git commit and push this change back to the repo.
    displayName: "Update Manifests (Placeholder)"
